@page
@model BulkMailSender.Pages.TemplateModel
@{
    ViewData["Title"] = "Draft Email";
}

<style>
    .template-preview { white-space: pre-wrap; border: 1px solid #dee2e6; border-radius: .5rem; padding: 1rem; background: #fff; }
    .sticky-reminder { position: sticky; top: 0; z-index: 10; }
    .placeholder-pill { display:inline-block; padding:.375rem .5rem; border:1px dashed #6c757d; border-radius:.25rem; color:#6c757d; background:#f8f9fa; }
</style>

<div class="row">
    <div class="col-md-10 offset-md-1">
        <h2 class="mb-4"><i class="bi bi-envelope"></i> Configure Email Type</h2>

        @if (!Model.HasUploadData)
        {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> No attachment upload found. Please <a asp-page="/Upload">upload attachments</a> and recipients first.
            </div>
        }

        <div class="alert alert-info sticky-reminder">
            <strong>Reminder:</strong> Set the period (e.g., OCT 2025). This is easy to forget.
        </div>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-circle"></i> @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <form method="post">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Email Settings</h5>
                    <small class="text-muted">SOA/INV or Overdue</small>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email Type</label>
                            <select class="form-select @(ModelState.GetFieldValidationState(nameof(Model.TemplateType)) == Microsoft.AspNetCore.Mvc.ModelBinding.ModelValidationState.Invalid ? "is-invalid" : "")" asp-for="TemplateType">
                                <option value="">-- Select Email --</option>
                                <option value="SoaInv">SOA &amp; Invoice</option>
                                <option value="Overdue">Overdue</option>
                            </select>
                            <span class="invalid-feedback d-block">@Html.ValidationMessage(nameof(Model.TemplateType))</span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Period (e.g., OCT 2025)</label>
                            <input class="form-control @(ModelState.GetFieldValidationState(nameof(Model.Period)) == Microsoft.AspNetCore.Mvc.ModelBinding.ModelValidationState.Invalid ? "is-invalid" : "")" asp-for="Period"/>
                            <div class="form-text">Make sure this matches the attachments period.</div>
                            <span class="invalid-feedback d-block">@Html.ValidationMessage(nameof(Model.Period))</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">
                            <i class="bi bi-check2-circle"></i> 
                            <strong>Checklist:</strong> Email Type selected &bull; Period filled
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" formaction="?handler=Save" class="btn btn-success"><i class="bi bi-save"></i> Save Template</button>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-clipboard-check"></i> Go to Review</button>
                    </div>
                </div>
            </div>
        </form>

        <div class="card mb-4 border-info">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-eye"></i> Preview Email (Optional)</h5>
                <small class="text-muted">Test how the email will look with different settings</small>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="Preview">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Preview Email Type</label>
                            <select class="form-select" name="PreviewTemplateType" id="previewTemplateType">
                                <option value="">-- Select Email Type --</option>
                                <option value="SoaInv" selected="@(Model.PreviewTemplateType == BulkMailSender.Pages.TemplateType.SoaInv)">SOA &amp; Invoice</option>
                                <option value="Overdue" selected="@(Model.PreviewTemplateType == BulkMailSender.Pages.TemplateType.Overdue)">Overdue</option>
                            </select>
                            <div class="form-text">For preview only</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Preview Period</label>
                            <input type="text" class="form-control" name="PreviewPeriod" id="previewPeriod" placeholder="e.g., OCT 2025" value="@Model.PreviewPeriod"/>
                            <div class="form-text">For preview only</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Select Debtor Code</label>
                            <select class="form-select" asp-for="DebtorCode" id="debtorCodeSelect">
                                <option value="">-- Select a debtor --</option>
                                @foreach (var d in Model.AvailableDebtorCodes)
                                {
                                    <option value="@d.DebtorCode">@d.DebtorCode (@d.EmailCount email(s))</option>
                                }
                            </select>
                            <div class="form-text">Choose a debtor to preview</div>
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(Model.SelectedOrganizationName) || !string.IsNullOrWhiteSpace(Model.SelectedNotes))
                    {
                        <div class="row g-3 mt-3">
                            <div class="col-12">
                                <div class="alert alert-light border">
                                    <h6 class="mb-2">Selected Debtor Info:</h6>
                                    <p class="mb-1"><strong>Debtor Code:</strong> @Model.DebtorCode</p>
                                    <p class="mb-1"><strong>Organization:</strong> @Model.SelectedOrganizationName</p>
                                    <p class="mb-0"><strong>Notes:</strong> @Model.SelectedNotes</p>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="row g-3 mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> <strong>Note:</strong> Preview settings are independent from the saved template above. Fill in Email Type and Period here to test the preview.
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mt-3">
                        <div class="col-12 d-flex justify-content-end">
                            <button type="submit" class="btn btn-outline-primary"><i class="bi bi-eye"></i> Preview</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.SubjectPreview))
        {
            <div class="card mb-4">
                <div class="card-header bg-primary text-white"><h5 class="mb-0">Subject Preview</h5></div>
                <div class="card-body">
                    <div class="template-preview">@Model.SubjectPreview</div>
                </div>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(Model.BodyPreview))
        {
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white"><h5 class="mb-0">Body Preview</h5></div>
                <div class="card-body">
                    <div class="template-preview">@Model.BodyPreview</div>
                </div>
            </div>
        }

        <div class="card">
            <div class="card-header"><h5 class="mb-0">Default Bodies</h5></div>
            <div class="card-body">
                <h6>SOA &amp; Invoice</h6>
<pre class="template-preview">Good day to you
The attached statement reflects your account balance.

Please check the statement provided.

If you have any questions regarding this statement or any clarification needs, please contact the ATP Careline 018-7864855

Any overdue payment may lead to service interruption.

The below are the bank details for your payment purpose:-
Company Name: ATP SALES &amp; SERVICES SDN BHD
Bank Name: Affin Bank Bhd
Bank Account Number: 10675 0000 898
Email (Banking Slip): &lt;atgroupoperation02@gmail.com&gt;

***************************************************************************

This is an auto-generated email, please DO NOT REPLY. Any replies to this
email will be disregarded.

***************************************************************************</pre>
                <h6 class="mt-4">Overdue</h6>
<pre class="template-preview">Good day to you

Kindly find the attached statement of account and invoice.

According to our payment term with your company, your are requested to make the payment within {notes} after you receive the monthly statement of account. Please clear and remit, if any. If you have made the payment, please let me know and I will update accordingly

Bearing in mind, as company policy

ATP shall be entitled, at its absolute discretion, to suspend Customer's account and hold service call until overdue outstanding has been fully paid.

Thank you

PIC name: Ms. Ika
Email: atgroupoperation02@gmail.com
Direct Line: 018-7864855</pre>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Optional: You can add any preview-related JavaScript here if needed
    </script>
}
