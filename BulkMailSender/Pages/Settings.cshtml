@page
@model BulkMailSender.Pages.SettingsModel
@{
    ViewData["Title"] = "SMTP Settings";
}

<div class="row">
    <div class="col-md-10 offset-md-1">
        <h2 class="mb-4"><i class="bi bi-gear"></i> SMTP Email Settings</h2>

        <div class="alert alert-info">
            <strong>Choose a preset or configure manually:</strong>
            <ul class="mb-0">
                <li><strong>Default (Gmail)</strong> - Production SMTP for sending real emails</li>
                <li><strong>PaperCut</strong> - Local SMTP testing (requires PaperCut SMTP running on localhost:25)</li>
            </ul>
        </div>

        @if (!string.IsNullOrEmpty(Model.TestResult))
        {
            <div class="alert @(Model.TestSuccess ? "alert-success" : "alert-danger")">
                @Model.TestResult
            </div>
        }

        <form method="post">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Quick Presets</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2">
                        <button type="submit" asp-page-handler="UseDefault" class="btn btn-primary">
                            <i class="bi bi-envelope"></i> Use Default (Gmail)
                        </button>
                        <button type="submit" asp-page-handler="UsePaperCut" class="btn btn-warning">
                            <i class="bi bi-bug"></i> Use PaperCut (Debug)
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">SMTP Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">SMTP Host</label>
                            <input class="form-control" asp-for="CurrentSettings.Host" value="@Model.CurrentSettings.Host" placeholder="smtp.gmail.com" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Port</label>
                            <input type="number" class="form-control" asp-for="CurrentSettings.Port" value="@Model.CurrentSettings.Port" placeholder="587" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Username</label>
                            <input class="form-control" asp-for="CurrentSettings.Username" value="@Model.CurrentSettings.Username" placeholder="your-email@gmail.com" />
                            <div class="form-text">Leave blank for PaperCut/no auth.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Password</label>
                            <input type="password" class="form-control" asp-for="CurrentSettings.Password" value="@Model.CurrentSettings.Password" placeholder="App password" />
                            <div class="form-text">Gmail: Use App Password, not regular password.</div>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-bold">From Email</label>
                            <input type="email" class="form-control" asp-for="CurrentSettings.FromEmail" value="@Model.CurrentSettings.FromEmail" placeholder="sender@example.com" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">From Name</label>
                            <input class="form-control" asp-for="CurrentSettings.FromName" value="@Model.CurrentSettings.FromName" placeholder="ATP Bulk Mailer" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Timeout (seconds)</label>
                            <input type="number" class="form-control" asp-for="CurrentSettings.TimeoutSeconds" value="@Model.CurrentSettings.TimeoutSeconds" placeholder="30" />
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                @if (Model.CurrentSettings.EnableSsl)
                                {
                                    <input class="form-check-input" type="checkbox" asp-for="CurrentSettings.EnableSsl" checked />
                                }
                                else
                                {
                                    <input class="form-check-input" type="checkbox" asp-for="CurrentSettings.EnableSsl" />
                                }
                                <label class="form-check-label fw-bold">Enable SSL/TLS</label>
                                <div class="form-text">Required for Gmail (port 587).</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-end gap-2">
                    <button type="submit" asp-page-handler="TestConnection" class="btn btn-info">
                        <i class="bi bi-send-check"></i> Test Connection
                    </button>
                    <button type="submit" asp-page-handler="Save" class="btn btn-success">
                        <i class="bi bi-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </form>

        <div class="card">
            <div class="card-header"><h5 class="mb-0">Setup Guide</h5></div>
            <div class="card-body">
                <h6>Gmail Configuration</h6>
                <ol>
                    <li>Go to <a href="https://myaccount.google.com/apppasswords" target="_blank">Google App Passwords</a></li>
                    <li>Create a new app password for "Mail"</li>
                    <li>Copy the 16-character password (remove spaces)</li>
                    <li>Use it in the Password field above</li>
                    <li>Host: <code>smtp.gmail.com</code>, Port: <code>587</code>, SSL: <strong>Enabled</strong></li>
                </ol>

                <h6 class="mt-3">PaperCut SMTP (Debugging)</h6>
                <ol>
                    <li>Download <a href="https://github.com/ChangemakerStudios/Papercut-SMTP/releases" target="_blank">PaperCut SMTP</a></li>
                    <li>Run PaperCut.exe</li>
                    <li>Click "Options" ? Ensure port is 25 (default)</li>
                    <li>Use "PaperCut" preset above</li>
                    <li>Emails appear in PaperCut window (not sent to real recipients)</li>
                </ol>

                <div class="alert alert-warning mt-3">
                    <strong>Security Note:</strong> SMTP credentials are stored in session memory only. They are cleared when you close the browser or after 30 minutes of inactivity.
                </div>
            </div>
        </div>
    </div>
</div>
