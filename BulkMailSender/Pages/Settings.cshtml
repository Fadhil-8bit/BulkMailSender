@page
@model BulkMailSender.Pages.SettingsModel
@{
    ViewData["Title"] = "SMTP Settings";
}

<div class="row">
    <div class="col-md-10 offset-md-1">
        <h2 class="mb-4"><i class="bi bi-gear"></i> Email Configuration</h2>

        @if (Model.HasSavedSettings)
        {
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> <strong>Settings Loaded from Persistent Storage</strong>
                <p class="mb-0 mt-2 small">Your settings are saved and will persist across application restarts.</p>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.TestResult))
        {
            <div class="alert @(Model.TestSuccess ? "alert-success" : "alert-danger")">
                @Model.TestResult
            </div>
        }

        <form method="post">
            <!-- Load Presets -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> Load Preset Configuration</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        <i class="bi bi-info-circle"></i> Choose a preset configuration to quickly set up SMTP settings. 
                        The selected preset will be <strong>automatically saved</strong>. You can then customize individual 
                        settings below if needed, and click "Save Settings" to persist your changes.
                    </p>
                    
                    <div class="row g-3">
                        <!-- Production/Default Preset -->
                        <div class="col-md-6">
                            <div class="card h-100 border border-success">
                                <div class="card-body">
                                    <h6 class="card-title text-success">
                                        <i class="bi bi-cloud-check"></i> Load Default (Production)
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Load production SMTP settings for sending real emails via Brevo.
                                    </p>
                                    <div class="mt-3">
                                        <strong class="small">Configured:</strong>
                                        <ul class="small mt-2 mb-3">
                                            <li>Host: smtp-relay.brevo.com</li>
                                            <li>Port: 587</li>
                                            <li>SSL: Enabled</li>
                                            <li>Authentication: Yes</li>
                                        </ul>
                                    </div>
                                    <div class="alert alert-info mb-0 py-2">
                                        <small><i class="bi bi-info-circle"></i> Automatically saves when loaded</small>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <button type="submit" asp-page-handler="UseDefault" class="btn btn-success w-100">
                                        <i class="bi bi-gear-fill"></i> Load & Save Default
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- PaperCut Testing Preset -->
                        <div class="col-md-6">
                            <div class="card h-100 border border-warning">
                                <div class="card-body">
                                    <h6 class="card-title text-warning">
                                        <i class="bi bi-bug"></i> Use PaperCut (Testing)
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Load local SMTP settings for testing. Emails are captured locally, not sent to real recipients.
                                    </p>
                                    <div class="mt-3">
                                        <strong class="small">Configured:</strong>
                                        <ul class="small mt-2 mb-3">
                                            <li>Host: localhost</li>
                                            <li>Port: 25</li>
                                            <li>SSL: Disabled</li>
                                            <li>No Authentication</li>
                                        </ul>
                                    </div>
                                    <div class="alert alert-info mb-0 py-2">
                                        <small><i class="bi bi-info-circle"></i> Automatically saves when loaded</small>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <button type="submit" asp-page-handler="UsePaperCut" class="btn btn-warning w-100">
                                        <i class="bi bi-bug"></i> Load & Save PaperCut
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-tools"></i> Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="submit" asp-page-handler="TestConnection" class="btn btn-info">
                            <i class="bi bi-send-check"></i> Test Connection
                        </button>
                        <button type="submit" asp-page-handler="Save" class="btn btn-success">
                            <i class="bi bi-save"></i> Save Settings
                        </button>
                        @if (Model.HasSavedSettings)
                        {
                            <button type="submit" asp-page-handler="ClearSettings" class="btn btn-outline-danger" 
                                    onclick="return confirm('Are you sure you want to clear saved settings?');">
                                <i class="bi bi-trash"></i> Clear Saved Settings
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- SMTP Server Configuration -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-envelope-at"></i> SMTP Server Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">SMTP Host</label>
                            <input class="form-control" asp-for="CurrentSettings.Host" placeholder="smtp.example.com" />
                            <div class="form-text">Your SMTP server hostname or IP address</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Port</label>
                            <input type="number" class="form-control" asp-for="CurrentSettings.Port" placeholder="587" />
                            <div class="form-text">Common: 25, 587, 465</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Username</label>
                            <input class="form-control" asp-for="CurrentSettings.Username" placeholder="smtp-username" autocomplete="username" />
                            <div class="form-text">Leave blank if no authentication required</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Password / SMTP Key</label>
                            <input type="password" class="form-control" asp-for="CurrentSettings.Password" placeholder="••••••••" autocomplete="current-password" />
                            <div class="form-text">SMTP password or API key</div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold">Timeout (seconds)</label>
                            <input type="number" class="form-control" asp-for="CurrentSettings.TimeoutSeconds" placeholder="30" />
                            <div class="form-text">Connection timeout</div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="form-check mt-4 pt-2">
                                <input class="form-check-input" type="checkbox" asp-for="CurrentSettings.EnableSsl" />
                                <label class="form-check-label fw-bold">
                                    Enable SSL/TLS
                                </label>
                                <div class="form-text">Required for port 587/465</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sender Information -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-person-badge"></i> Sender Information</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">From Email Address</label>
                            <input type="email" class="form-control" asp-for="CurrentSettings.FromEmail" placeholder="noreply@example.com" />
                            <div class="form-text">Must be verified with your SMTP provider</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">From Name</label>
                            <input class="form-control" asp-for="CurrentSettings.FromName" placeholder="ATP Bulk Mailer" />
                            <div class="form-text">Display name for emails</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global CC Recipients -->
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-people-fill"></i> Global CC Recipients</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> <strong>What are Global CC Recipients?</strong>
                        <p class="mb-0 mt-2">These email addresses will be automatically CC'd on <strong>every email</strong> sent by the system, regardless of the recipients list.</p>
                    </div>
                    
                    <label class="form-label fw-bold">
                        <i class="bi bi-envelope-plus"></i> CC Email Addresses
                    </label>
                    <input class="form-control form-control-lg" asp-for="CurrentSettings.GlobalCc" 
                           placeholder="email1@example.com; email2@example.com; email3@example.com" />
                    <div class="form-text mt-2">
                        <i class="bi bi-arrow-right"></i> Separate multiple email addresses with semicolons (<code>;</code>)
                        <br /><i class="bi bi-arrow-right"></i> Example: <code>manager@company.com; admin@company.com</code>
                        <br /><i class="bi bi-arrow-right"></i> Leave blank to disable global CC
                    </div>
                    
                    @if (!string.IsNullOrWhiteSpace(Model.CurrentSettings.GlobalCc))
                    {
                        <div class="mt-3 p-3 bg-light rounded">
                            <small class="text-muted fw-bold">Currently configured:</small>
                            <div class="mt-2">
                                @foreach (var email in Model.CurrentSettings.GlobalCc.Split(';', StringSplitOptions.RemoveEmptyEntries).Select(e => e.Trim()))
                                {
                                    <span class="badge bg-warning text-dark me-2 mb-2">
                                        <i class="bi bi-envelope"></i> @email
                                    </span>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </form>

        <!-- Setup Guide -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-book"></i> Setup Guide</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="setupAccordion">
                    
                    <!-- Production SMTP -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#prodSmtp">
                                <i class="bi bi-cloud"></i> <strong class="ms-2">Production SMTP Setup</strong>
                            </button>
                        </h2>
                        <div id="prodSmtp" class="accordion-collapse collapse" data-bs-parent="#setupAccordion">
                            <div class="accordion-body">
                                <h6>Common SMTP Providers:</h6>
                                
                                <div class="mb-3">
                                    <strong>Option 1: Brevo (Recommended - 300 emails/day FREE)</strong>
                                    <ol class="mb-0">
                                        <li>Go to <a href="https://app.brevo.com" target="_blank">app.brevo.com</a></li>
                                        <li>Navigate to Settings ? SMTP & API</li>
                                        <li>Generate a new SMTP key</li>
                                        <li>Use settings:
                                            <ul>
                                                <li>Host: <code>smtp-relay.brevo.com</code></li>
                                                <li>Port: <code>587</code></li>
                                                <li>Username: Your Brevo login email</li>
                                                <li>Password: The SMTP key you generated</li>
                                                <li>SSL: <strong>Enabled</strong></li>
                                            </ul>
                                        </li>
                                    </ol>
                                </div>

                                <div class="mb-3">
                                    <strong>Option 2: SendGrid</strong>
                                    <ul class="mb-0">
                                        <li>Host: <code>smtp.sendgrid.net</code></li>
                                        <li>Port: <code>587</code> or <code>465</code></li>
                                        <li>Username: <code>apikey</code></li>
                                        <li>Password: Your SendGrid API key</li>
                                        <li>SSL: <strong>Enabled</strong></li>
                                    </ul>
                                </div>

                                <div>
                                    <strong>Option 3: Mailgun</strong>
                                    <ul class="mb-0">
                                        <li>Host: <code>smtp.mailgun.org</code></li>
                                        <li>Port: <code>587</code></li>
                                        <li>Username: Your Mailgun SMTP username</li>
                                        <li>Password: Your Mailgun SMTP password</li>
                                        <li>SSL: <strong>Enabled</strong></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PaperCut Testing -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#papercut">
                                <i class="bi bi-bug"></i> <strong class="ms-2">PaperCut SMTP (Local Testing)</strong>
                            </button>
                        </h2>
                        <div id="papercut" class="accordion-collapse collapse" data-bs-parent="#setupAccordion">
                            <div class="accordion-body">
                                <p><strong>PaperCut SMTP</strong> is a local email viewer for testing. Emails are captured locally and not sent to real recipients.</p>
                                <ol>
                                    <li>Download <a href="https://github.com/ChangemakerStudios/Papercut-SMTP/releases" target="_blank">PaperCut SMTP</a></li>
                                    <li>Run PaperCut.exe</li>
                                    <li>Ensure port is set to 25 (default)</li>
                                    <li>Click "Use PaperCut (Testing)" button above</li>
                                    <li>Send test emails - they'll appear in PaperCut window</li>
                                </ol>
                                <div class="alert alert-warning mb-0">
                                    <i class="bi bi-exclamation-triangle"></i> <strong>Testing Only:</strong> Emails are NOT sent to real recipients when using PaperCut.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security & Storage -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#security">
                                <i class="bi bi-shield-lock"></i> <strong class="ms-2">Security & Storage Information</strong>
                            </button>
                        </h2>
                        <div id="security" class="accordion-collapse collapse" data-bs-parent="#setupAccordion">
                            <div class="accordion-body">
                                <h6>How Settings are Stored:</h6>
                                <ul>
                                    <li><strong>File Storage:</strong> <code>App_Data/smtp-settings.json</code></li>
                                    <li><strong>Session Storage:</strong> In-memory cache (30 minutes)</li>
                                    <li><strong>Persistence:</strong> Settings survive application restarts</li>
                                </ul>

                                <h6 class="mt-3">Security Notes:</h6>
                                <div class="alert alert-warning">
                                    <ul class="mb-0">
                                        <li><i class="bi bi-shield-check"></i> Settings file is excluded from Git (<code>.gitignore</code>)</li>
                                        <li><i class="bi bi-shield-check"></i> Not accessible via HTTP</li>
                                        <li><i class="bi bi-exclamation-triangle"></i> Do NOT commit <code>App_Data/</code> to source control</li>
                                        <li><i class="bi bi-info-circle"></i> For production: Consider Azure Key Vault or environment variables</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>
